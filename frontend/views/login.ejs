<div class="card">
  <div class="logo">
    <img src="/images/logo.png" alt="SafeBallot Logo">
  </div>
  
  <h1>Sign in</h1>
  <h2>Welcome to VoteChain.</h2>
  
  <hr class="divider">
  
  <form id="login-form" action="/api/login" method="POST">
    <div class="form-group">
      <label for="email">Email</label>
      <input type="email" id="email" name="email" placeholder="email@email.com" required>
    </div>
    
    <div class="form-group">
      <label for="password">Password</label>
      <div class="password-field">
        <input type="password" id="password" name="password" placeholder="password" required>
        <span class="password-toggle">👁️‍🗨️</span>
      </div>
    </div>
    
    <button type="submit">Sign in</button>
  </form>
</div>

<script>
  document.getElementById('login-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    
    // Show some feedback to user
    const submitButton = this.querySelector('button[type="submit"]');
    const originalText = submitButton.textContent;
    submitButton.textContent = 'Signing in...';
    submitButton.disabled = true;
    
    fetch('/api/login', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ email, password })
    })
    .then(response => {
      // Log the raw response for debugging
      console.log('Response status:', response.status);
      
      // Check if response is ok before parsing JSON
      if (!response.ok) {
        throw new Error(`Server responded with status: ${response.status}`);
      }
      
      return response.json();
    })
    .then(data => {
      console.log('Login response:', data);
      
      if (data && data.success) {
        localStorage.setItem('token', data.data.token);
        
        // Use the role from the server response
        const userRole = data.data && data.data.role ? data.data.role : 'voter';
        localStorage.setItem('userRole', userRole);
        
        // Store email for OTP verification
        localStorage.setItem('userEmail', data.data.email);
        
        // Store OTP (for demo purposes only - in real app this would not be sent to client)
        localStorage.setItem('currentOTP', data.data.otp);
        
        // Get ballot ID if it exists in URL
        const urlParams = new URLSearchParams(window.location.search);
        const ballotId = urlParams.get('ballot');
        
        // Redirect to OTP verification page
        if (ballotId) {
          window.location.href = `/otp?ballot=${ballotId}`;
        } else {
          window.location.href = '/otp';
        }
      } else {
        // Handle server-side validation errors
        const errorMessage = data && data.message ? data.message : 'Login failed';
        alert(errorMessage);
        
        // Reset button
        submitButton.textContent = originalText;
        submitButton.disabled = false;
      }
    })
    .catch(error => {
      console.error('Login error details:', error);
      alert('An error occurred during login. Please try again.');
      
      // Reset button
      submitButton.textContent = originalText;
      submitButton.disabled = false;
    });
  });
</script> 